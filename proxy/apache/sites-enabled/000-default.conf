<VirtualHost *:80>
    ServerName email_domain.tld
    Redirect permanent / https://email_domain.tld
</VirtualHost>
<VirtualHost *:80>
    ServerName api.email_domain.tld
    Redirect permanent / https://api.email_domain.tld
</VirtualHost>
<VirtualHost *:443>
    ServerName email_domain.tld

    SSLEngine on
    SSLProxyEngine on
    SSLCertificateFile /etc/letsencrypt/live/email_domain.tld/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/email_domain.tld/privkey.pem

    ProxyPreserveHost On
    ProxyPass / http://ember:80/
    ProxyPassReverse / http://ember:80/
    ProxyRequests off

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
<VirtualHost *:443>
    ServerName api.email_domain.tld
    SSLEngine on
    SSLProxyEngine on
    SSLCertificateFile /etc/letsencrypt/live/email_domain.tld/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/email_domain.tld/privkey.pem

    ProxyPreserveHost On
    ProxyPass / http://jsonapi:9010/
    ProxyPassReverse / http://jsonapi:9010/
    ProxyRequests off

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
<VirtualHost *:443>
    ServerName oauth2.email_domain.tld
    SSLEngine on
    SSLProxyEngine on
    SSLCertificateFile /etc/letsencrypt/live/email_domain.tld/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/email_domain.tld/privkey.pem

    ProxyPreserveHost On
    ProxyPass / http://oauth2:9020/
    ProxyPassReverse / http://oauth2:9020/
    ProxyRequests off

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
<VirtualHost *:443>
# in case we need socket.io for RTC
    ServerName secure.email_domain.tld
    SSLEngine on
    SSLProxyEngine on
    SSLCertificateFile /etc/letsencrypt/live/email_domain.tld/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/email_domain.tld/privkey.pem

    RewriteEngine on
    RewriteCond ${HTTP:Upgrade} websocket [NC]
    RewriteCond ${HTTP:Connection} upgrade [NC]
    RewriteRule .* "wss:/secure.email_domain.tld/$1" [P,L]

    ProxyPreserveHost On
    ProxyPass / ws://transmission:9080/
    ProxyPassReverse / ws://transmission:9080/
    ProxyRequests off

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
